# -*- coding:utf-8 -*-# soctt.bin created  2011.5.7 # sw2us.com @2011 #import sys,os,os.path,time,struct,traceback,threading,datetime,struct,array,sqlite3import  pickle,hashlib,base64from taxbase import CallReturnimport taxbasefrom taxctrl import *sql_templ = '''CREATE TABLE "core_invoice" (    "inv_type" varchar(30) NOT NULL,    "inv_code" varchar(80) NOT NULL,    "inv_number" varchar(80) NOT NULL,    "client_nr" varchar(80),    "itemcount" integer,    "cust_name" varchar(320),    "cust_tax_code" varchar(50),    "cust_address_tel" varchar(320),    "cust_bank_account" varchar(320),    "crypt_ver" varchar(30),    "crypt_text" text,    "inv_date" varchar(30),    "inv_month" varchar(30),    "inv_amount" varchar(30),    "inv_taxrate" varchar(30),    "inv_tax" varchar(30),    "goods_name" varchar(320),    "taxitem" varchar(80),    "memo" varchar(240),    "issuer" varchar(30),    "checker" varchar(30),    "payee" varchar(30),    "flag_dy" varchar(30),    "flag_zf" varchar(30),    "flag_qd" varchar(30),    "flag_xf" varchar(30),    "flag_dj" varchar(30),    "flag_wk" varchar(30),    "seller_name" varchar(240),    "seller_taxcode" varchar(240),    "seller_address" varchar(240),    "seller_bankacct" varchar(240),    "isupload"  INTEGER NOT NULL DEFAULT 0);CREATE TABLE "core_invoiceitem" (    "inv_code" varchar(80) NOT NULL,    "inv_number" varchar(80) NOT NULL,    "taxcode" varchar(50) NOT NULL,    "item_name" varchar(80),    "taxitem" varchar(30),    "spec" varchar(80),    "unit" varchar(30),    "qty" varchar(30),    "price" varchar(30),    "taxrate" varchar(30),    "tax" varchar(30),    "flag_tax" varchar(30));'''from dbconn import *class TaxMemDB:	def __init__(self,file):		#self.db = sqlite3.connect(':memory:')		sql = ''		if not os.path.exists(file):			sql = sql_templ		self.db = sqlite3.connect(file)		self.db.text_factory = str#		print file,self.db		if sql:			self.db.executescript(sql)	def handle(self):		return self.db	def encrypt_s(self,s):		s = encrypt_des('flag_tax',s)		s = base64.encodestring(s)		return s	def decrypt_s(self,s):		try:			s = base64.decodestring(s)			s = decrypt_des('flag_tax',s)			return s		except:			return ''	def addInvoice(self,inv):		sql = "select count(*) as cnt from core_invoice where inv_code=? and inv_number=? "		cr = self.db.cursor()		cr.execute(sql,(inv.inv_code,inv.inv_number))#		rs = cr.fetchone()		rs = fetchoneDict(cr)		if rs['cnt']:			return True		inv.inv_amount = self.encrypt_s(inv.inv_amount)		sql ="insert into core_invoice values(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)"		cr = self.db.cursor()		itemcount = len(inv.items)		cr.execute(sql,(inv.inv_type,						inv.inv_code,						inv.inv_number,						inv.client_nr,						itemcount,		                inv.cust_name,		                inv.cust_tax_code,		                inv.cust_address_tel,		                inv.cust_bank_account,		                inv.crypt_ver,		                inv.crypt_text,		                inv.inv_date,		                inv.inv_month,		                inv.inv_amount,		                inv.inv_taxrate,		                inv.inv_tax,		                inv.goods_name,		                inv.taxitem,		                inv.memo,		                inv.issuer,		                inv.checker,		                inv.payee,		                inv.flag_dy,		                inv.flag_zf,		                inv.flag_qd,		                inv.flag_xf,		                inv.flag_dj,		                inv.flag_wk,		                inv.seller_name,		                inv.seller_taxcode,		                inv.seller_address,		                inv.seller_bankacct,						inv.isupload))		sql = 'insert into core_invoiceitem values(?,?,?,?,?,?,?,?,?,?,?,?)'		cr = self.db.cursor()		for item in inv.items:			cr.execute(sql,(				self.encrypt_s(inv.inv_code),			    self.encrypt_s(inv.inv_number),			    inv.cust_tax_code,			    item.item_name,			    item.taxitem,			    item.spec,			    item.unit,			    item.qty,			    item.price,			    item.taxrate,			    item.tax,			    item.flag_tax			))		self.db.commit()		pass	def deleteInvoice(self,code,number):		try:			cur = self.db.cursor()			sql = "delete from core_invoice where inv_code=? and inv_number=? "			cur.execute(sql,(code,number))			coce = self.encrypt_s(code)			number = self.encrypt_s(number)			sql = 'delete  from core_invoiceitem where inv_code=? and inv_number=?'			cr = self.db.cursor()			cr.execute(sql,(code,number))			self.db.commit()		except:			print traceback.format_exc()			return False		return True	def setUploaded(self,code,number):		try:			cur = self.db.cursor()			sql = "update core_invoice set isupload=1 where inv_code=? and inv_number=? "			cur.execute(sql,(code,number))			self.db.commit()		except:			print traceback.format_exc()			return False		return True	def getInvoice(self,taxcode,taxnumber):		from taxctrl import InvoiceInfo,InvoiceGoodsItem		inv = None		try:			inv = InvoiceInfo()			sql = "select * from core_invoice where inv_code=? and inv_number=? "			cr = self.db.cursor()			cr.execute(sql,(taxcode,taxnumber))			rs = fetchallDict(cr)			for r in rs:				inv.inv_type = r['inv_type']				inv.inv_code = r['inv_code']				inv.inv_number = r['inv_number']				inv.client_nr = r['client_nr']				inv.cust_name = r['cust_name']				inv.cust_tax_code =r['cust_tax_code']				inv.cust_address_tel =r['cust_address_tel']				inv.cust_bank_account =r['cust_bank_account']				inv.crypt_ver = r['crypt_ver']				inv.crypt_text = r['crypt_text']				inv.inv_date = r['inv_date']				inv.inv_month = r['inv_month']				inv.inv_amount = r['inv_amount']				inv.inv_taxrate =r['inv_taxrate']				inv.inv_tax =r['inv_tax']				inv.goods_name =r['goods_name']				inv.taxitem =r['taxitem']				inv.memo =r['memo']				inv.issuer =r['issuer']				inv.checker = r['checker']				inv.payee = r['payee']				inv.flag_dy =r['flag_dy']				inv.flag_zf =r['flag_zf']				inv.flag_qd =r['flag_qd']				inv.flag_xf =r['flag_xf']				inv.flag_dj =r['flag_dj']				inv.flag_wk =r['flag_wk']				inv.seller_name =r['seller_name']				inv.seller_taxcode =r['seller_taxcode']				inv.seller_address = r['seller_address']				inv.seller_bankacct =r['seller_bankacct']				inv.isupload = r['isupload']			taxcode = self.encrypt_s(taxcode)			taxnumber = self.encrypt_s(taxnumber)			sql = 'select * from core_invoiceitem where inv_code=? and inv_number=?'			cr = self.db.cursor()			cr.execute(sql,(taxcode,taxnumber))			rs = fetchallDict(cr)			for r in rs:				item = InvoiceGoodsItem()				item.item_name = r['item_name']				item.taxitem = r['taxitem']				item.spec = r['spec']				item.unit = r['unit']				item.qty = r['qty']				item.price = r['price']				item.taxrate = r['taxrate']				item.tax = r['tax']				item.flag_tax =r['flag_tax']				inv.items.append(item)			inv.inv_amount = self.decrypt_s(inv.inv_amount)		except:			traceback.print_exc()			inv = None		return inv		passclass TaxDataSource:	def __init__(self,persist_file='persist.dat'):		self.taxcode = ''		self.persist_file = persist_file		self.db = None		self.invoices=[]		self.encrypt_text_db = ''		self.key_dog = ''		self.secinfo = None # {taxcode,priv-key}	def close(self):		pass	def open(self,lic):		'''			load identification			open key from dog			load records from persist_file,			push records into sqlite in memory		'''		self.db = TaxMemDB()		self.key_dog = ''		self.key_dog = hashlib.md5(self.key_dog).hexdigest()[:8]		self.taxcode_dog = ''		#detect .lic file		f = None		try:			f = open('%s.lic',self.taxcode_dog)		except:			print 'license file not found corresponding with dog!'			return False		d = pickle.load(f)		f.close()		self.secinfo = decrypt_des(self.key_dog,d)		if self.secinfo['taxcode'] != self.taxcode_dog:			print 'taxcode not equal with in dog!'			return False		#load invoices from local file		f = open(self.persist_file)		d = pickle.load(f)		f.close()		self.invoices = decrypt_des(self.key_dog,d)		for inv in self.invoices:#			inv.decrypt()			self.db.addInvoice(inv)	def addInvoices(self,invoices):		self.invoices+=invoices		for inv in invoices:			self.db.addInvoice(inv)		self.save()	def deleteInvoice(self,taxcode,code,number):		self.db.deleteInvoice(taxcode,code,number)		for n in range(self.invoices):			inv = self.invoices[n]			if inv.cust_tax_code == taxcode and \				code == inv.inv_code and \				number == inv.inv_number:				del self.invoices[n]				break		self.save()	def save(self):		'''			save records into disc		'''		d = pickle.dumps(self.invoices)		d = encrypt_des(self.key_dog,d)		f = open(self.persist_file,'w')		f.write(d)		f.close()		passdef test():	pass	if __name__=='__main__':	test()	